<%- include('../partials/header') %>

    <main>
        <div class="container movie-detail-container">

            <!-- Movie Information Section -->
            <section class="movie-info-section">
                <div class="movie-poster-container">
                    <% if (movie.image) { %>
                        <img src="<%= movie.image %>" alt="<%= movie.title %> poster" class="movie-poster-large">
                        <% } else { %>
                            <div class="movie-poster-large placeholder">No Image Available</div>
                            <% } %>
                </div>

                <div class="movie-details">
                    <h1 class="movie-title">
                        <%= movie.title %>
                    </h1>

                    <div class="movie-meta">
                        <span class="meta-item">
                            <strong>Year:</strong>
                            <%= movie.year || 'N/A' %>
                        </span>
                        <span class="meta-divider">•</span>
                        <span class="meta-item">
                            <strong>Rating:</strong>
                            <%= movie.rating || 'Not Rated' %>
                        </span>
                        <% if (movie.genre) { %>
                            <span class="meta-divider">•</span>
                            <span class="meta-item">
                                <strong>Genre:</strong>
                                <%= movie.genre %>
                            </span>
                            <% } %>
                    </div>

                    <% if (movie.plot) { %>
                        <div class="movie-plot">
                            <h2>Plot</h2>
                            <p>
                                <%= movie.plot %>
                            </p>
                        </div>
                        <% } %>

                            <div class="review-stats">
                                <strong>
                                    <%= movie.review_count || 0 %>
                                </strong> user review<%= (movie.review_count || 0) !==1 ? 's' : '' %>
                            </div>
                </div>
            </section>

            <!-- Review Form Section (Only for logged-in users) -->
            <% if (isAuthenticated) { %>
                <section class="review-form-section">

                    <!-- Success Message -->
                    <% if (successMessage) { %>
                        <div class="alert alert-success">
                            <%= successMessage %>
                        </div>
                        <% } %>

                            <!-- Validation Errors -->
                            <% if (errors && errors.length> 0) { %>
                                <div class="alert alert-error">
                                    <ul class="error-list">
                                        <% errors.forEach(error=> { %>
                                            <li>
                                                <%= error.msg %>
                                            </li>
                                            <% }) %>
                                    </ul>
                                </div>
                                <% } %>

                                    <h2>
                                        <%= userReview ? 'Edit Your Review' : 'Write a Review' %>
                                    </h2>
                                    <p class="form-description">
                                        <%= userReview ? 'Update your thoughts about this movie.'
                                            : 'Share your thoughts about this movie.' %>
                                    </p>

                                    <form action="/movies/<%= movie.id %>/review" method="POST" id="reviewForm"
                                        class="review-form">
                                        <div class="form-group">
                                            <label for="reviewText">Your Review:</label>
                                            <textarea name="review" id="reviewText" class="review-textarea"
                                                placeholder="Write your review here... (minimum 10 characters)" required
                                                minlength="10"
                                                maxlength="1000"><%= userReview ? userReview.review : '' %></textarea>
                                            <div class="char-counter">
                                                <span id="charCount">0</span> / 1000 characters
                                                <span id="charMinWarning" class="char-warning" style="display: none;">
                                                    (Minimum 10 characters required)
                                                </span>
                                            </div>
                                        </div>

                                        <div class="form-actions">
                                            <button type="submit" class="btn primary-btn" id="submitBtn">
                                                <%= userReview ? 'Update Review' : 'Submit Review' %>
                                            </button>
                                            <% if (userReview) { %>
                                                <button type="button" class="btn secondary-btn"
                                                    onclick="deleteReview()">
                                                    Delete Review
                                                </button>
                                                <% } %>
                                        </div>
                                    </form>
                </section>
                <% } else { %>
                    <section class="login-prompt-section">
                        <div class="login-prompt-box">
                            <h3>Want to share your thoughts?</h3>
                            <p><a href="/auth/login?returnTo=<%= '/movies/' + movie.id %>" class="login-link">Login</a>
                                or
                                <a href="/auth/register?returnTo=<%= '/movies/' + movie.id %>"
                                    class="login-link">Register</a>
                                to add a review
                            </p>
                        </div>
                    </section>
                    <% } %>

                        <!-- Reviews List Section -->
                        <section class="reviews-list-section">
                            <h2>User Reviews (<%= reviews.length %>)</h2>

                            <% if (reviews && reviews.length> 0) { %>
                                <div class="reviews-container">
                                    <% reviews.forEach(review=> { %>
                                        <article class="review-card">
                                            <div class="review-header">
                                                <div class="review-author">
                                                    <strong>
                                                        <%= review.username %>
                                                    </strong>
                                                    <% if (isAuthenticated && review.user_id===user.id) { %>
                                                        <span class="your-review-badge">Your Review</span>
                                                        <% } %>
                                                </div>
                                                <div class="review-date">
                                                    <%= new Date(review.created_at).toLocaleDateString('en-US', {
                                                        year: 'numeric' , month: 'long' , day: 'numeric' }) %>
                                                        <% if (review.edited) { %>
                                                            <span class="edited-badge">(edited)</span>
                                                            <% } %>
                                                </div>
                                            </div>
                                            <div class="review-content">
                                                <p>
                                                    <%= review.review %>
                                                </p>
                                            </div>
                                        </article>
                                        <% }) %>
                                </div>
                                <% } else { %>
                                    <div class="no-reviews">
                                        <p>No reviews yet. Be the first to share your thoughts!</p>
                                    </div>
                                    <% } %>
                        </section>

                        <!-- Back to Home Button -->
                        <div class="back-to-home">
                            <a href="/home" class="btn secondary-btn">← Back to Home</a>
                        </div>

        </div>
    </main>

    <script>
        // Character counter functionality
        const reviewText = document.getElementById('reviewText');
        const charCount = document.getElementById('charCount');
        const charMinWarning = document.getElementById('charMinWarning');
        const submitBtn = document.getElementById('submitBtn');

        if (reviewText && charCount) {
            // Update character count
            function updateCharCount() {
                const length = reviewText.value.length;
                charCount.textContent = length;

                // Show/hide minimum character warning
                if (length > 0 && length < 10) {
                    charMinWarning.style.display = 'inline';
                    charMinWarning.style.color = '#e74c3c';
                } else {
                    charMinWarning.style.display = 'none';
                }

                // Enable/disable submit button
                if (submitBtn) {
                    submitBtn.disabled = length < 10;
                }
            }

            reviewText.addEventListener('input', updateCharCount);

            // Initialize on page load
            updateCharCount();
        }

        // Delete review function (for Phase 4)
        function deleteReview() {
            if (confirm('Are you sure you want to delete your review? This action cannot be undone.')) {
                alert('Delete functionality will be implemented in Phase 4');
                // Will be implemented in Phase 4:
                // fetch('/movies/reviews/<%= movie.id %>', { method: 'DELETE' })
                // .then(res => res.json())
                // .then(data => { if (data.success) window.location.reload(); })
            }
        }
    </script>

    <style>
        /* Movie Detail Page Styles */
        .movie-detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .movie-info-section {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .movie-poster-large {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .movie-poster-large.placeholder {
            height: 450px;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .movie-details {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .movie-title {
            font-size: 2.5rem;
            margin: 0;
            color: #2c3e50;
        }

        .movie-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            color: #666;
            font-size: 1.1rem;
        }

        .meta-divider {
            color: #ccc;
        }

        .movie-plot h2 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
            color: #34495e;
        }

        .movie-plot p {
            line-height: 1.6;
            color: #555;
        }

        .review-stats {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 4px;
            color: #666;
            margin-top: auto;
        }

        /* Review Form Section */
        .review-form-section,
        .login-prompt-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            border-left: 4px solid;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .error-list {
            margin: 0;
            padding-left: 1.5rem;
        }

        .error-list li {
            margin: 0.25rem 0;
        }

        .review-form-section h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .form-description {
            color: #666;
            margin-bottom: 1.5rem;
        }

        .review-textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .review-textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .char-counter {
            text-align: right;
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .char-warning {
            color: #e74c3c;
            font-weight: bold;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .primary-btn {
            background: #3498db;
            color: white;
        }

        .primary-btn:hover:not(:disabled) {
            background: #2980b9;
        }

        .primary-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .secondary-btn {
            background: #95a5a6;
            color: white;
        }

        .secondary-btn:hover {
            background: #7f8c8d;
        }

        /* Login Prompt */
        .login-prompt-box {
            text-align: center;
            padding: 2rem;
        }

        .login-prompt-box h3 {
            margin-top: 0;
            color: #2c3e50;
        }

        .login-link {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
        }

        .login-link:hover {
            text-decoration: underline;
        }

        /* Reviews List Section */
        .reviews-list-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .reviews-list-section h2 {
            margin-top: 0;
            color: #2c3e50;
        }

        .reviews-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .review-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            background: #f8f9fa;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .review-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .your-review-badge {
            background: #3498db;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: normal;
        }

        .review-date {
            color: #666;
            font-size: 0.9rem;
        }

        .edited-badge {
            color: #7f8c8d;
            font-style: italic;
            font-size: 0.85rem;
        }

        .review-content p {
            line-height: 1.6;
            color: #2c3e50;
            margin: 0;
        }

        .no-reviews {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        /* Back Button */
        .back-to-home {
            text-align: center;
            margin-top: 2rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .movie-info-section {
                grid-template-columns: 1fr;
            }

            .movie-title {
                font-size: 2rem;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>

    <%- include('../partials/footer') %>